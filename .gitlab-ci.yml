stages: [mirror, verify]
mirror_to_github:
  stage: mirror
  image: alpine:3.20
  tags:
    - docker
  variables:
    GITHUB_REPO: "baileylu121/multi-region-cloud-system"
  before_script:
    - apk add --no-cache git
  script:
    - git remote add github https://oauth2:${GITHUB_TOKEN}@github.com/${GITHUB_REPO}.git 2>/dev/null || git remote set-url github https://oauth2:${GITHUB_TOKEN}@github.com/${GITHUB_REPO}.git
    - git push github HEAD:${CI_COMMIT_BRANCH} --force
  only:
    - branches
garnix_checks:
  stage: verify
  needs:
    - mirror_to_github
  image: alpine:3.20
  tags:
    - docker
  variables:
    GITHUB_REPO: "baileylu121/multi-region-cloud-system"
    GITHUB_CHECK_TIMEOUT: "900"
    GITHUB_CHECK_INTERVAL: "15"
    OK_CONCLUSIONS: "success,neutral,skipped"
  before_script:
    - apk update && apk add --no-cache curl jq gum bash
  script:
    - bash scripts/check-garnix.sh
