stages: [verify]
github_all_checks:
  stage: verify
  image: alpine:3.20
  tags:
    - docker
  variables:
    GITHUB_REPO: "YOUR_OWNER/YOUR_REPO" # owner/repo of the GitHub mirror
    GITHUB_CHECK_TIMEOUT: "900" # seconds
    GITHUB_CHECK_INTERVAL: "15" # seconds
    # Treat these as "non-failing" conclusions for check suites/runs.
    # If you truly want ONLY success, set this to just: success
    OK_CONCLUSIONS: "success,neutral,skipped"
  before_script:
    - |
      for i in 1 2 3; do
        apk update && apk add --no-cache curl jq && break
        echo "Attempt $i failed, retrying..."
        sleep 5
      done
    - |
      if [ -z "${GITHUB_TOKEN:-}" ]; then
        echo "ERROR: Set GITHUB_TOKEN in GitLab CI/CD variables."
        exit 2
      fi
  script:
    - |
      set -euo pipefail

      SHA="${CI_COMMIT_SHA}"
      REPO="${GITHUB_REPO}"
      API="https://api.github.com"
      AUTH="Authorization: Bearer ${GITHUB_TOKEN}"
      ACCEPT="Accept: application/vnd.github+json"
      UA="User-Agent: gitlab-github-all-checks-gate"

      timeout_s="${GITHUB_CHECK_TIMEOUT}"
      interval_s="${GITHUB_CHECK_INTERVAL}"

      # Build a jq predicate for OK_CONCLUSIONS
      ok_list_json="$(printf '%s' "${OK_CONCLUSIONS}" | awk -v RS=',' 'NF{gsub(/^[ \t]+|[ \t]+$/, "", $0); print}' | jq -R . | jq -s .)"

      fetch_check_suites() {
        curl -fsSL -H "${AUTH}" -H "${ACCEPT}" -H "${UA}" \
          "${API}/repos/${REPO}/commits/${SHA}/check-suites"
      }

      fetch_combined_status() {
        curl -fsSL -H "${AUTH}" -H "${ACCEPT}" -H "${UA}" \
          "${API}/repos/${REPO}/commits/${SHA}/status"
      }

      start_ts="$(date +%s)"
      echo "Gating on GitHub 'All checks' for ${REPO}@${SHA}"
      echo "Timeout=${timeout_s}s Interval=${interval_s}s OK_CONCLUSIONS=${OK_CONCLUSIONS}"

      while true; do
        now_ts="$(date +%s)"
        elapsed="$(( now_ts - start_ts ))"
        if [ "${elapsed}" -ge "${timeout_s}" ]; then
          echo "ERROR: Timed out waiting for GitHub checks to finish."
          exit 1
        fi

        # 1) Checks API: check suites (this is the closest match to GitHub's "All checks")
        suites_json="$(fetch_check_suites)"
        suite_total="$(echo "${suites_json}" | jq -r '.total_count // 0')"

        if [ "${suite_total}" -gt 0 ]; then
          echo "Check suites:"
          echo "${suites_json}" | jq -r '
            .check_suites[]
            | " - app=\(.app.slug // .app.name // "unknown") status=\(.status) conclusion=\(.conclusion // "null") url=\(.url)"
          '

          # Any suites still running?
          suites_incomplete="$(echo "${suites_json}" | jq '[.check_suites[] | select(.status != "completed")] | length')"
          if [ "${suites_incomplete}" -gt 0 ]; then
            echo "Some check suites not completed yet (${suites_incomplete}). Waiting..."
            sleep "${interval_s}"
            continue
          fi

          # Any suite concluded with a failing conclusion?
          suites_bad="$(echo "${suites_json}" | jq --argjson ok "${ok_list_json}" '
            [ .check_suites[]
              | select((.conclusion // "null") as $c | ($ok | index($c) | not))
            ] | length
          ')"

          if [ "${suites_bad}" -gt 0 ]; then
            echo "ERROR: One or more check suites concluded with a non-OK conclusion."
            echo "${suites_json}" | jq --argjson ok "${ok_list_json}" -r '
              .check_suites[]
              | select((.conclusion // "null") as $c | ($ok | index($c) | not))
              | "FAILED SUITE: app=\(.app.slug // .app.name // "unknown") conclusion=\(.conclusion // "null") url=\(.url)"
            '
            exit 1
          fi

          echo "OK: All check suites completed with OK conclusions."
        else
          echo "No check suites found for this commit (Checks API)."
        fi

        # 2) Status API: combined status (covers classic contexts)
        status_json="$(fetch_combined_status)"
        state="$(echo "${status_json}" | jq -r '.state')"
        echo "Combined status state=${state}"
        echo "${status_json}" | jq -r '
          .statuses[]
          | " - context=\(.context) state=\(.state) url=\(.target_url // "null") desc=\(.description // "null")"
        '

        case "${state}" in
          success)
            echo "OK: GitHub combined status is success. 'All checks' should be green."
            exit 0
            ;;
          pending)
            echo "Combined status pending. Waiting..."
            sleep "${interval_s}"
            ;;
          failure|error)
            echo "ERROR: GitHub combined status is ${state}."
            exit 1
            ;;
          *)
            echo "ERROR: Unexpected combined status state: ${state}"
            exit 2
            ;;
        esac
      done
